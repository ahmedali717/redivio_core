{% extends "auth_base.html" %}

{% block content %}
<div class="w-full max-w-2xl relative z-10" x-data="setupWizard()">
    <div class="bg-slate-900/80 backdrop-blur-xl border border-slate-700 p-10 rounded-2xl shadow-2xl">
        <h2 class="text-2xl font-bold text-white mb-6 tech-font">Finalize Configuration</h2>
        
        <div x-show="finalizing" class="text-center py-10">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-white" x-text="statusText"></p>
        </div>

        <div x-show="!finalizing">
            <p class="text-slate-400 mb-6">Setting up environment for: <strong class="text-white" x-text="companyName"></strong></p>
            
            <div class="space-y-4 mb-8">
                <div>
                    <label class="text-xs text-slate-400 block mb-1">Base Currency</label>
                    <select x-model="currency" class="input-field">
                        <option value="SAR">SAR - Saudi Riyal</option>
                        <option value="USD">USD - US Dollar</option>
                        <option value="EGP">EGP - Egyptian Pound</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-slate-400 block mb-1">Fiscal Year Start</label>
                    <input type="date" x-model="fiscalYear" class="input-field" value="2025-01-01">
                </div>
            </div>

            <button @click="finish()" :disabled="loading" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg">
                <span x-show="!loading">LAUNCH DASHBOARD <i class="fas fa-rocket ml-2"></i></span>
                <span x-show="loading">INITIALIZING...</span>
            </button>
        </div>
    </div>
</div>

<script>
    function setupWizard() {
        return {
            loading: false,
            finalizing: false,
            statusText: 'Connecting...',
            companyName: '',
            currency: 'SAR',
            fiscalYear: '2025-01-01',

            init() {
                // استرجاع اسم الشركة للعرض فقط
                const savedData = JSON.parse(localStorage.getItem('signupData') || '{}');
                this.companyName = savedData.company || 'My Company';
            },

            async finish() {
                this.loading = true;
                this.finalizing = true;
                
                // 1. تجميع البيانات من المراحل السابقة
                const signupData = JSON.parse(localStorage.getItem('signupData') || '{}');
                const selectedModules = JSON.parse(localStorage.getItem('selectedModules') || '[]');

                const payload = {
                    ...signupData,          // name, email, password, phone, company, industry
                    modules: selectedModules, // ['wms', 'sales', ...]
                    currency: this.currency,
                    fiscal_year: this.fiscalYear
                };

                // 2. محاكاة خطوات التسطيب (للعرض فقط)
                const steps = ["Creating database schema...", "Configuring modules...", "Setting currency rates...", "Finalizing..."];
                for (let step of steps) {
                    this.statusText = step;
                    await new Promise(r => setTimeout(r, 600));
                }

                // 3. الإرسال الفعلي للسيرفر
                try {
                    const response = await fetch('/api/signup/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCookie('csrftoken')
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        this.statusText = "Done! Redirecting...";
                        // تنظيف البيانات
                        localStorage.clear();
                        window.location.href = "{% url 'dashboard_home' %}";
                    } else {
                        const err = await response.json();
                        alert("Error: " + JSON.stringify(err));
                        this.finalizing = false;
                        this.loading = false;
                    }
                } catch (error) {
                    alert("Connection failed");
                    this.finalizing = false;
                    this.loading = false;
                }
            },
            
            getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        }
    }
</script>
{% endblock %}