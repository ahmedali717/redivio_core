import os
from pathlib import Path

# ==========================================
# 1. ÿ™ÿπÿ±ŸäŸÅ ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÖŸÑŸÅÿßÿ™
# ==========================================

# Settings.py
settings_content = """
from pathlib import Path
import os

BASE_DIR = Path(__file__).resolve().parent.parent
SECRET_KEY = 'django-insecure-cloud-setup-key'
DEBUG = True
ALLOWED_HOSTS = ['*'] # ŸÖŸáŸÖ ŸÑŸÑŸÉŸÑÿßŸàÿØ

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'corsheaders',
    'apps.core',
    'apps.wms',
    'apps.item_master',
    'apps.procurement',
    'apps.sales',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'redivio_project.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'redivio_project.wsgi.application'

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

AUTH_PASSWORD_VALIDATORS = []
LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'UTC'
USE_I18N = True
USE_TZ = True

STATIC_URL = 'static/'
STATICFILES_DIRS = [BASE_DIR / 'static']
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'
"""

# Models
core_models = """from django.db import models
from django.contrib.auth import get_user_model
User = get_user_model()
class OpCo(models.Model):
    owner = models.ForeignKey(User, on_delete=models.CASCADE, related_name='companies', null=True, blank=True)
    name = models.CharField(max_length=100)
    code = models.CharField(max_length=20, unique=True)
    currency = models.CharField(max_length=3, default='USD')
    created_at = models.DateTimeField(auto_now_add=True)
    def __str__(self): return self.name
"""

wms_models = """from django.db import models
class Plant(models.Model):
    opco = models.ForeignKey('core.OpCo', on_delete=models.CASCADE, related_name='plants')
    code = models.CharField(max_length=5) 
    name = models.CharField(max_length=100)
    type = models.CharField(max_length=3, default='WH')
    def __str__(self): return self.name
class StorageLocation(models.Model):
    plant = models.ForeignKey(Plant, on_delete=models.CASCADE, related_name='locations') 
    code = models.CharField(max_length=10)
    name = models.CharField(max_length=100)
    extra_data = models.JSONField(default=dict, blank=True)
    def __str__(self): return f"{self.plant.code} - {self.code}"
class StorageBin(models.Model):
    storage_location = models.ForeignKey(StorageLocation, on_delete=models.CASCADE, related_name='bins')
    code = models.CharField(max_length=20, default='BIN-000')
    is_active = models.BooleanField(default=True)
    def __str__(self): return self.code
class StockQuant(models.Model):
    opco = models.ForeignKey('core.OpCo', on_delete=models.CASCADE)
    plant = models.ForeignKey(Plant, on_delete=models.CASCADE)
    storage_bin = models.ForeignKey(StorageBin, on_delete=models.PROTECT)
    material = models.ForeignKey('item_master.Material', on_delete=models.PROTECT)
    quantity = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    class Meta: unique_together = ('storage_bin', 'material')
class StockMove(models.Model):
    opco = models.ForeignKey('core.OpCo', on_delete=models.CASCADE)
    material = models.ForeignKey('item_master.Material', on_delete=models.PROTECT)
    source_bin = models.ForeignKey(StorageBin, related_name='out_moves', null=True, blank=True, on_delete=models.SET_NULL)
    dest_bin = models.ForeignKey(StorageBin, related_name='in_moves', null=True, blank=True, on_delete=models.SET_NULL)
    quantity = models.DecimalField(max_digits=12, decimal_places=2)
    reference = models.CharField(max_length=100)
    date = models.DateTimeField(auto_now_add=True)
    move_type = models.CharField(max_length=10, choices=[('IN', 'In'), ('OUT', 'Out')])
"""

item_models = """from django.db import models
class Material(models.Model):
    code = models.CharField(max_length=20)
    name = models.CharField(max_length=100)
    def __str__(self): return self.name
class Category(models.Model):
    name = models.CharField(max_length=50)
class FieldDefinition(models.Model):
    name = models.CharField(max_length=50)
"""

proc_models = """from django.db import models
class Vendor(models.Model): name = models.CharField(max_length=100)
class PurchaseOrder(models.Model): 
    opco = models.ForeignKey('core.OpCo', on_delete=models.CASCADE, null=True)
    status = models.CharField(max_length=20, default='DRAFT')
class PurchaseOrderLine(models.Model): pass
"""

sales_models = """from django.db import models
class Customer(models.Model): name = models.CharField(max_length=100)
class SalesOrder(models.Model): pass
class SalesOrderLine(models.Model): pass
"""

# Serializers
serializers_py = """from rest_framework import serializers
from apps.core.models import OpCo
from apps.wms.models import Plant, StorageLocation, StorageBin, StockQuant, StockMove
from apps.item_master.models import Material, Category, FieldDefinition
from apps.procurement.models import Vendor, PurchaseOrder, PurchaseOrderLine
from apps.sales.models import Customer, SalesOrder, SalesOrderLine

class OpCoSerializer(serializers.ModelSerializer):
    class Meta: model = OpCo; fields = '__all__'
class PlantSerializer(serializers.ModelSerializer):
    class Meta: model = Plant; fields = '__all__'
class StorageLocationSerializer(serializers.ModelSerializer):
    class Meta: model = StorageLocation; fields = '__all__'
class StorageBinSerializer(serializers.ModelSerializer):
    class Meta: model = StorageBin; fields = '__all__'
class StockQuantSerializer(serializers.ModelSerializer):
    class Meta: model = StockQuant; fields = '__all__'
class StockMoveSerializer(serializers.ModelSerializer):
    class Meta: model = StockMove; fields = '__all__'
class MaterialSerializer(serializers.ModelSerializer):
    class Meta: model = Material; fields = '__all__'
class CategorySerializer(serializers.ModelSerializer):
    class Meta: model = Category; fields = '__all__'
class FieldDefinitionSerializer(serializers.ModelSerializer):
    class Meta: model = FieldDefinition; fields = '__all__'
class VendorSerializer(serializers.ModelSerializer):
    class Meta: model = Vendor; fields = '__all__'
class PurchaseOrderSerializer(serializers.ModelSerializer):
    class Meta: model = PurchaseOrder; fields = '__all__'
class PurchaseOrderLineSerializer(serializers.ModelSerializer):
    class Meta: model = PurchaseOrderLine; fields = '__all__'
class CustomerSerializer(serializers.ModelSerializer):
    class Meta: model = Customer; fields = '__all__'
class SalesOrderSerializer(serializers.ModelSerializer):
    class Meta: model = SalesOrder; fields = '__all__'
class SalesOrderLineSerializer(serializers.ModelSerializer):
    class Meta: model = SalesOrderLine; fields = '__all__'
"""

# Core Views
core_views = """from django.shortcuts import render, redirect
from django.contrib.auth import authenticate, login, logout, get_user_model
from django.db import transaction
from django.db.models import Sum
from django.views.decorators.csrf import ensure_csrf_cookie
from rest_framework import viewsets, status
from rest_framework.views import APIView
from rest_framework.decorators import api_view, permission_classes, authentication_classes
from rest_framework.authentication import SessionAuthentication
from rest_framework.permissions import AllowAny, IsAuthenticated
from rest_framework.response import Response
from apps.core.models import OpCo
from apps.wms.models import Plant, StorageLocation, StockQuant, StorageBin
from apps.item_master.models import Material
from apps.procurement.models import Vendor, PurchaseOrder
from apps.core.serializers import OpCoSerializer, PlantSerializer, StorageLocationSerializer, StorageBinSerializer

User = get_user_model()

@ensure_csrf_cookie
def landing_view(request):
    if request.user.is_authenticated: return redirect('dashboard_home')
    return render(request, 'landing.html') 
def login_view(request):
    if request.user.is_authenticated: return redirect('dashboard_home')
    return render(request, 'login.html')
def logout_view(request):
    logout(request)
    return redirect('/') 
def signup_view(request): return render(request, 'signup.html')
def modules_puzzle_view(request): return render(request, 'modules_puzzle.html')
def otp_view(request): return render(request, 'otp.html')
def setup_view(request): return render(request, 'setup.html')
@ensure_csrf_cookie
def dashboard_view(request): return render(request, 'index.html')

@api_view(['POST'])
@permission_classes([AllowAny])
def check_email_status(request):
    email = request.data.get('email')
    if not email: return Response({'exists': False})
    exists = User.objects.filter(email__iexact=email).exists()
    return Response({'exists': exists})

class CheckAuthAPI(APIView):
    permission_classes = [AllowAny]
    def get(self, request):
        if request.user.is_authenticated:
            company_name = "REDIVIO Inc."
            user_opco = OpCo.objects.filter(owner=request.user).first()
            if user_opco: company_name = user_opco.name
            return Response({
                "authenticated": True, "user": request.user.username,
                "email": request.user.email, "company": company_name,
                "is_superuser": request.user.is_superuser,
                "role": 'Admin' if request.user.is_superuser else 'Manager'
            })
        return Response({"authenticated": False})

class LoginAPI(APIView):
    permission_classes = [AllowAny]
    def post(self, request):
        email = request.data.get('username')
        password = request.data.get('password')
        user = authenticate(request, username=email, password=password)
        if user is not None:
            login(request, user)
            return Response({"message": "Success", "redirect_url": "/dashboard/"})
        return Response({"error": "Invalid email or password"}, status=400)

class TenantSignupAPI(APIView):
    permission_classes = [AllowAny]
    def post(self, request):
        data = request.data
        company_name = data.get('company') or data.get('company_name')
        email = data.get('email')
        password = data.get('password')
        if not (company_name and email): return Response({"error": "Missing required fields"}, status=400)
        try:
            with transaction.atomic():
                user, created = User.objects.get_or_create(username=email, defaults={'email': email, 'is_superuser': False, 'is_staff': True})
                if created:
                    user.set_password(password if password else 'Admin@123')
                    user.save()
                if not request.user.is_authenticated:
                    login(request, user, backend='django.contrib.auth.backends.ModelBackend')
                import random, string
                random_code = ''.join(random.choices(string.ascii_uppercase + string.digits, k=4))
                opco, created = OpCo.objects.get_or_create(name=company_name, defaults={'code': random_code, 'owner': user})
                if created:
                    plant = Plant.objects.create(opco=opco, code="MAIN", name=f"{company_name} HQ")
                    StorageLocation.objects.create(plant=plant, code="IN-1", name="Receiving")
                return Response({"message": "Workspace ready!", "redirect_url": "/dashboard/"}, status=status.HTTP_201_CREATED)
        except Exception as e: return Response({"error": str(e)}, status=500)

class DashboardDataViewSet(viewsets.ViewSet):
    authentication_classes = [SessionAuthentication]
    permission_classes = [IsAuthenticated]
    def list(self, request):
        user_opcos = OpCo.objects.filter(owner=request.user)
        stock_qty = 0
        if user_opcos.exists():
             stock_qty = StockQuant.objects.filter(storage_bin__storage_location__plant__opco__in=user_opcos).aggregate(total=Sum('quantity'))['total'] or 0
        kpis = {
            'materials': Material.objects.count(),
            'vendors': Vendor.objects.count(),
            'pending_pos': PurchaseOrder.objects.filter(opco__in=user_opcos, status='DRAFT').count(),
            'stock_qty': stock_qty,
        }
        return Response({'kpis': kpis})

class OpCoViewSet(viewsets.ModelViewSet):
    authentication_classes = [SessionAuthentication]
    permission_classes = [IsAuthenticated]
    serializer_class = OpCoSerializer
    def get_queryset(self): return OpCo.objects.filter(owner=self.request.user)
    def perform_create(self, serializer): serializer.save(owner=self.request.user)
class PlantViewSet(viewsets.ModelViewSet):
    authentication_classes = [SessionAuthentication]
    permission_classes = [IsAuthenticated]
    serializer_class = PlantSerializer
    def get_queryset(self): return Plant.objects.filter(opco__owner=self.request.user)
class LocationViewSet(viewsets.ModelViewSet):
    authentication_classes = [SessionAuthentication]
    permission_classes = [IsAuthenticated]
    serializer_class = StorageLocationSerializer
    def get_queryset(self): return StorageLocation.objects.filter(plant__opco__owner=self.request.user)
class StorageBinViewSet(viewsets.ModelViewSet):
    authentication_classes = [SessionAuthentication]
    permission_classes = [IsAuthenticated]
    serializer_class = StorageBinSerializer
    def get_queryset(self): return StorageBin.objects.filter(storage_location__plant__opco__owner=self.request.user)
"""

# Dummy ViewSets
dummy_views = """from rest_framework import viewsets
from .models import *
from apps.core.serializers import *
class MaterialViewSet(viewsets.ModelViewSet):
    queryset = Material.objects.all(); serializer_class = MaterialSerializer
class CategoryViewSet(viewsets.ModelViewSet):
    queryset = Category.objects.all(); serializer_class = CategorySerializer
class FieldDefinitionViewSet(viewsets.ModelViewSet):
    queryset = FieldDefinition.objects.all(); serializer_class = FieldDefinitionSerializer
"""
dummy_views_proc = """from rest_framework import viewsets
from .models import *
from apps.core.serializers import *
def print_po_pdf(request, pk): return None
class VendorViewSet(viewsets.ModelViewSet):
    queryset = Vendor.objects.all(); serializer_class = VendorSerializer
class PurchaseOrderViewSet(viewsets.ModelViewSet):
    queryset = PurchaseOrder.objects.all(); serializer_class = PurchaseOrderSerializer
class PurchaseOrderLineViewSet(viewsets.ModelViewSet):
    queryset = PurchaseOrderLine.objects.all(); serializer_class = PurchaseOrderLineSerializer
"""
dummy_views_sales = """from rest_framework import viewsets
from .models import *
from apps.core.serializers import *
class CustomerViewSet(viewsets.ModelViewSet):
    queryset = Customer.objects.all(); serializer_class = CustomerSerializer
class SalesOrderViewSet(viewsets.ModelViewSet):
    queryset = SalesOrder.objects.all(); serializer_class = SalesOrderSerializer
class SalesOrderLineViewSet(viewsets.ModelViewSet):
    queryset = SalesOrderLine.objects.all(); serializer_class = SalesOrderLineSerializer
class StockQuantViewSet(viewsets.ModelViewSet):
    queryset = StockQuant.objects.all(); serializer_class = StockQuantSerializer
class StockMoveViewSet(viewsets.ModelViewSet):
    queryset = StockMove.objects.all(); serializer_class = StockMoveSerializer
"""

# URLs
main_urls = """from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static
from rest_framework.routers import DefaultRouter
from apps.core.views import OpCoViewSet, PlantViewSet, LocationViewSet, StorageBinViewSet, logout_view
from apps.item_master.views import MaterialViewSet, CategoryViewSet, FieldDefinitionViewSet
from apps.wms.views import StockQuantViewSet, StockMoveViewSet
from apps.procurement.views import VendorViewSet, PurchaseOrderViewSet, PurchaseOrderLineViewSet, print_po_pdf
from apps.sales.views import CustomerViewSet, SalesOrderViewSet, SalesOrderLineViewSet

router = DefaultRouter()
router.register(r'opcos', OpCoViewSet, basename='opco')
router.register(r'plants', PlantViewSet, basename='plant')
router.register(r'locations', LocationViewSet, basename='location')
router.register(r'bins', StorageBinViewSet, basename='bin')
router.register(r'materials', MaterialViewSet, basename='material')
router.register(r'categories', CategoryViewSet, basename='category')
router.register(r'fields', FieldDefinitionViewSet, basename='fielddefinition')
router.register(r'inventory', StockQuantViewSet, basename='stockquant')
router.register(r'moves', StockMoveViewSet, basename='stockmove')
router.register(r'vendors', VendorViewSet, basename='vendor')
router.register(r'orders', PurchaseOrderViewSet, basename='purchaseorder')
router.register(r'order-lines', PurchaseOrderLineViewSet, basename='purchaseorderline')
router.register(r'customers', CustomerViewSet, basename='customer')
router.register(r'sales-orders', SalesOrderViewSet, basename='salesorder')
router.register(r'sales-lines', SalesOrderLineViewSet, basename='salesorderline')

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include(router.urls)),
    path('print/po/<int:pk>/', print_po_pdf, name='print_po_pdf'),
    path('logout/', logout_view, name='logout'),
    path('', include('apps.core.urls')),
]
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
    urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)
"""

core_urls = """from django.urls import path
from . import views
urlpatterns = [
    path('', views.landing_view, name='landing_page'),
    path('login/', views.login_view, name='login_page'),
    path('logout/', views.logout_view, name='logout_action'),
    path('signup/', views.signup_view, name='signup_page'),
    path('building-core/', views.modules_puzzle_view, name='modules_page'),
    path('verify-otp/', views.otp_view, name='otp_page'),
    path('setup-account/', views.setup_view, name='setup_page'),
    path('dashboard/', views.dashboard_view, name='dashboard_home'),
    path('api/check-auth/', views.CheckAuthAPI.as_view(), name='api_check_auth'),
    path('api/login/', views.LoginAPI.as_view(), name='api_user_login'),
    path('api/signup/', views.TenantSignupAPI.as_view(), name='api_tenant_signup'),
    path('api/check-email/', views.check_email_status, name='api_check_email'),
    path('api/dashboard-data/', views.DashboardDataViewSet.as_view({'get': 'list'}), name='api_dashboard_data'),
]
"""

# ==========================================
# 2. ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸáŸäŸÉŸÑ Ÿàÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑŸÖŸÑŸÅÿßÿ™
# ==========================================

# ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿ¥ÿ±Ÿàÿπ ÿ¨ÿßŸÜÿ¨Ÿà ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
if not os.path.exists("manage.py"):
    os.system("django-admin startproject redivio_project .")

apps = ['core', 'wms', 'item_master', 'procurement', 'sales']

# ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ¨ŸÑÿØÿßÿ™
for app in apps:
    os.makedirs(f"apps/{app}/migrations", exist_ok=True)
    Path(f"apps/{app}/__init__.py").touch()
    Path(f"apps/{app}/migrations/__init__.py").touch()

os.makedirs("templates", exist_ok=True)
os.makedirs("static", exist_ok=True)

# ŸÉÿ™ÿßÿ®ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™
files_map = {
    'redivio_project/settings.py': settings_content,
    'redivio_project/urls.py': main_urls,
    
    'apps/core/models.py': core_models,
    'apps/core/views.py': core_views,
    'apps/core/urls.py': core_urls,
    'apps/core/serializers.py': serializers_py,
    
    'apps/wms/models.py': wms_models,
    'apps/wms/views.py': dummy_views_sales.replace("StockMoveSerializer", "StockMoveSerializer"),
    
    'apps/item_master/models.py': item_models,
    'apps/item_master/views.py': dummy_views,
    
    'apps/procurement/models.py': proc_models,
    'apps/procurement/views.py': dummy_views_proc,
    
    'apps/sales/models.py': sales_models,
    'apps/sales/views.py': dummy_views_sales,
}

for path, content in files_map.items():
    with open(path, 'w', encoding='utf-8') as f:
        f.write(content)
    print(f"‚úÖ Created: {path}")

print("\nüöÄ Project Structure Ready! Now run migrations.")